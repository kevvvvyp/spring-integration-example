<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd

		http://www.springframework.org/schema/integration https://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/http https://www.springframework.org/schema/integration/http/spring-integration-http.xsd">

    <int-http:inbound-channel-adapter
            id="inboundAdapter"
            channel="inboundRequestChannel"
            supported-methods="POST"
            request-payload-type="com.kevvvvyp.springintegrationexample.pojo.request.AccountRequest"
            message-converters="mappingJackson2HttpMessageConverter"
            merge-with-default-converters="false"
            header-mapper="defaultHeaderMapper"
            path="/createPerson">
        <int-http:request-mapping consumes="application/json"/>
    </int-http:inbound-channel-adapter>

    <int:transformer id="inputValidator"
                     input-channel="inboundRequestChannel"
                     output-channel="lookupChannel"
                     ref="accountManager"
                     method="validation"/>

    <int:service-activator id="accountService"
                           input-channel="lookupChannel"
                           ref="accountManager"
                           method="accountLookup"
                           output-channel="processingInChannel"/>

    <int:transformer id="processingTransformer"
                     input-channel="processingInChannel"
                     output-channel="processingOutChannel"
                     ref="accountManager"
                     method="processing">
    </int:transformer>

    <int:transformer id="outboundRequestTransformer"
                     input-channel="processingOutChannel"
                     output-channel="outboundRequestChannel"
                     ref="accountManager"
                     method="createRequest">
    </int:transformer>

    <int-http:outbound-channel-adapter id="outboundAdapter"
                                       channel="outboundRequestChannel"
                                       url="${application.restTemplate.outboundUrl}"
                                       rest-template="restTemplate"
                                       header-mapper="defaultHeaderMapper"
                                       extract-payload="true"
                                       http-method="POST">

        <int-http:request-handler-advice-chain>
            <bean class="org.springframework.integration.handler.advice.RequestHandlerRetryAdvice">
                <property name="retryTemplate" ref="retryTemplate"/>
            </bean>
        </int-http:request-handler-advice-chain>
    </int-http:outbound-channel-adapter>


    <!-- ================ Channels/Loggers ===============-->
    <int:channel id="inboundRequestChannel">
        <int:dispatcher task-executor="taskExecutor"/>
        <int:interceptors>
            <int:wire-tap channel="inboundRequestLogger"/>
        </int:interceptors>
    </int:channel>

    <int:channel id="lookupChannel">
        <int:dispatcher task-executor="taskExecutor"/>
        <int:interceptors>
            <int:wire-tap channel="lookupChannelLogger"/>
        </int:interceptors>
    </int:channel>

    <int:channel id="processingInChannel">
        <int:interceptors>
            <int:wire-tap channel="processingInLogger"/>
        </int:interceptors>
    </int:channel>

    <int:channel id="processingOutChannel">
        <int:interceptors>
            <int:wire-tap channel="processingOutLogger"/>
        </int:interceptors>
    </int:channel>

    <int:channel id="outboundRequestChannel">
        <int:interceptors>
            <int:wire-tap channel="outboundRequestLogger"/>
        </int:interceptors>
    </int:channel>

    <int:logging-channel-adapter
            id="inboundRequestLogger"
            level="INFO"
            log-full-message="true"
            logger-name="WIRETAP.REQUEST-IN"/>

    <int:logging-channel-adapter
            id="lookupChannelLogger"
            level="INFO"
            log-full-message="true"
            logger-name="WIRETAP.LOOKUP-SERVICE"/>

    <int:logging-channel-adapter
            id="processingInLogger"
            level="INFO"
            log-full-message="true"
            logger-name="WIRETAP.PROCESSING-IN"/>

    <int:logging-channel-adapter
            id="processingOutLogger"
            level="INFO"
            log-full-message="true"
            logger-name="WIRETAP.PROCESSING-OUT"/>

    <int:logging-channel-adapter
            id="outboundRequestLogger"
            level="INFO"
            log-full-message="true"
            logger-name="WIRETAP.REQUEST-OUT"/>
</beans>